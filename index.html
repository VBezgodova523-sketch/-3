// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã
let currentGame = null;

const CONFIG = {
    mode: 'matching', // –ü–æ–∫–∞ —á—Ç–æ —Ç–æ–ª—å–∫–æ 'matching'
    timerEnabled: false,
    timeLimit: 60,
    items: [ // –ö–∞–∂–¥–∞—è –ø–∞—Ä–∞: –∑–∞–¥–∞–Ω–∏–µ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ—Ç–≤–µ—Ç
        { id: '1', taskContent: { type: 'text', value: 'Cat' }, targetContent: { type: 'image', value: 'https://cdn-icons-png.flaticaticon.com/512/104/104278.png' } },
        { id: '2', taskContent: { type: 'image', value: 'https://cdn-icons-png.flaticon.com/512/104/104278.png' }, targetContent: { type: 'text', value: 'Dog' } }, // –ü—Ä–∏–º–µ—Ä —Å –æ—à–∏–±–∫–æ–π –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        { id: '3', taskContent: { type: 'text', value: '–ö–æ—Ç' }, targetContent: { type: 'text', value: 'Cat' } }
    ],
    styles: {
        fontSize: "24px",
        color: "#ffffff",
        neon: true,
        fontFamily: "Arial"
    },
    feedback: {
        success: "–¢—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è! ‚≠ê",
        error: "–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑! Ô∏èü§î",
        final: "–£—Ä–∞! –í—Å–µ –ø–∞—Ä—ã —Å–æ–±—Ä–∞–Ω—ã!",
        icon: '‚≠ê' // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —á–∞—Å—Ç–∏—Ü
    },
    language: 'ru' // –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
};

class MatchGame {
    constructor(config) {
        this.config = config;
        this.container = document.getElementById('game-container');
        this.score = 0;
        this.matchedPairs = new Set(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä
        this.activeDraggedElement = null; // –≠–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—é—Ç

        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –ø—É–∑—ã—Ä–µ–π (–∑–∞–¥–∞–Ω–∏—è + —Ü–µ–ª–∏), —á—Ç–æ–±—ã –æ–Ω–∏ –ø–ª–∞–≤–∞–ª–∏
        this.allBubbles = []; 

        this.init();
    }

    init() {
        if (!this.container) {
            console.error("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #game-container –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            return;
        }
        this.container.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

        // –°–æ–∑–¥–∞–µ–º –≤—Å–µ –ø—É–∑—ã—Ä–∏ (–∫–∞–∫ –∑–∞–¥–∞–Ω–∏—è, —Ç–∞–∫ –∏ —Ü–µ–ª–∏)
        this.config.items.forEach(pair => {
            // –°–æ–∑–¥–∞–µ–º –ø—É–∑—ã—Ä—å –¥–ª—è –∑–∞–¥–∞–Ω–∏—è
            const taskBubble = this.createBubble(pair.taskContent, pair.id, 'task');
            this.container.appendChild(taskBubble);
            this.allBubbles.push(taskBubble);

            // –°–æ–∑–¥–∞–µ–º –ø—É–∑—ã—Ä—å –¥–ª—è —Ü–µ–ª–∏
            const targetBubble = this.createBubble(pair.targetContent, pair.id, 'target');
            this.container.appendChild(targetBubble);
            this.allBubbles.push(targetBubble);
        });

        this.allBubbles.forEach(bubble => this.animateBubble(bubble));

        // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è drag-and-drop
        this.container.addEventListener('mouseup', this.handleMouseUp.bind(this));
        this.container.addEventListener('mousemove', this.handleMouseMove.bind(this));
    }

    // –°–æ–∑–¥–∞–µ—Ç –ø—É–∑—ã—Ä—å —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º (—Ç–µ–∫—Å—Ç –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞)
    createBubble(content, id, type) {
        const el = document.createElement('div');
        el.className = 'floating-item';
        el.dataset.id = id;
        el.dataset.type = type; // 'task' –∏–ª–∏ 'target'
        el.style.fontSize = this.config.styles.fontSize;
        el.style.color = this.config.styles.color;
        el.style.fontFamily = this.config.styles.fontFamily;
        if (this.config.styles.neon) el.classList.add('neon-effect');

        const contentEl = document.createElement('div');
        contentEl.className = 'content';

        if (content.type === 'text') {
            contentEl.innerText = content.value;
        } else if (content.type === 'image') {
            const img = document.createElement('img');
            img.src = content.value;
            img.alt = `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è ${id}`;
            contentEl.appendChild(img);
        }
        el.appendChild(contentEl);

        // –°–ª—É—á–∞–π–Ω–∞—è –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
        el.style.left = Math.random() * (this.container.offsetWidth - 150) + 'px'; // -150 –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
        el.style.top = Math.random() * (this.container.offsetHeight - 150) + 'px';

        el.addEventListener('mousedown', (e) => this.handleMouseDown(e, el));
        return el;
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è "–ø–ª–∞–≤–∞–Ω–∏—è" –Ω–∞ –º–µ—Å—Ç–µ
    animateBubble(el) {
        let angle = Math.random() * Math.PI * 2;
        let speed = 0.05 + Math.random() * 0.05; // –ù–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
        const initialX = parseFloat(el.style.left);
        const initialY = parseFloat(el.style.top);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
        const animate = () => {
            if (el.parentNode === null) return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω

            const xOffset = Math.sin(angle) * 5; // –ù–µ–±–æ–ª—å—à–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
            const yOffset = Math.cos(angle) * 5;
            el.style.left = (initialX + xOffset) + 'px';
            el.style.top = (initialY + yOffset) + 'px';
            angle += speed;
            requestAnimationFrame(animate);
        };
        requestAnimationFrame(animate);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    handleMouseDown(e, el) {
        if (el.dataset.type !== 'task' || this.matchedPairs.has(el.dataset.id)) {
            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ "–∑–∞–¥–∞–Ω–∏—è", –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã
            return;
        }
        this.activeDraggedElement = el;
        el.style.zIndex = 1000; // –ü–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞–¥ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏
        el.style.cursor = 'grabbing';

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –º—ã—à–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        this.offsetX = e.clientX - el.getBoundingClientRect().left;
        this.offsetY = e.clientY - el.getBoundingClientRect().top;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    handleMouseMove(e) {
        if (!this.activeDraggedElement) return;

        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç, —É—á–∏—Ç—ã–≤–∞—è —Å–º–µ—â–µ–Ω–∏–µ
        this.activeDraggedElement.style.left = (e.clientX - this.offsetX) + 'px';
        this.activeDraggedElement.style.top = (e.clientY - this.offsetY) + 'px';
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
    handleMouseUp(e) {
        if (!this.activeDraggedElement) return;

        this.activeDraggedElement.style.zIndex = 1; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º z-index
        this.activeDraggedElement.style.cursor = 'grab';

        const draggedId = this.activeDraggedElement.dataset.id;
        let matched = false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å —Ü–µ–ª–µ–≤—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
        this.allBubbles.filter(b => b.dataset.type === 'target' && !this.matchedPairs.has(b.dataset.id))
                       .forEach(targetEl => {
            if (this.isOverlapping(this.activeDraggedElement, targetEl)) {
                if (draggedId === targetEl.dataset.id) {
                    this.matchFound(this.activeDraggedElement, targetEl);
                    matched = true;
                } else {
                    this.showFeedback(e.clientX, e.clientY, false);
                }
            }
        });

        if (!matched) {
            // –ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ –µ–≥–æ –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é)
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –Ω–∞ –º–µ—Å—Ç–µ –ø–æ—Å–ª–µ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è
            // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∏–ª–∏ –ø–ª–∞–≤–Ω–æ–µ "–æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ"
            this.activeDraggedElement.style.left = this.activeDraggedElement.getAttribute('data-initial-left') || this.activeDraggedElement.style.left;
            this.activeDraggedElement.style.top = this.activeDraggedElement.getAttribute('data-initial-top') || this.activeDraggedElement.style.top;
        }
        
        this.activeDraggedElement = null;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –¥–≤—É—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    isOverlapping(el1, el2) {
        const rect1 = el1.getBoundingClientRect();
        const rect2 = el2.getBoundingClientRect();
        return !(rect1.right < rect2.left || 
                 rect1.left > rect2.right || 
                 rect1.bottom < rect2.top || 
                 rect1.top > rect2.bottom);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ø–∞—Ä—ã
    matchFound(taskEl, targetEl) {
        const id = taskEl.dataset.id;
        if (this.matchedPairs.has(id)) return; // –£–∂–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ

        this.matchedPairs.add(id);
        this.score++;

        // –ê–Ω–∏–º–∏—Ä—É–µ–º "–ª–æ–ø–∞–Ω–∏–µ" –æ–±–æ–∏—Ö –ø—É–∑—ã—Ä–µ–π
        this.popBubble(taskEl);
        this.popBubble(targetEl);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π —Ñ–∏–¥–±–µ–∫ –≤ —Ç–æ—á–∫–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (—Å–µ—Ä–µ–¥–∏–Ω–∞ –º–µ–∂–¥—É –ø—É–∑—ã—Ä—è–º–∏)
        const taskRect = taskEl.getBoundingClientRect();
        const targetRect = targetEl.getBoundingClientRect();
        const centerX = (taskRect.left + taskRect.right + targetRect.left + targetRect.right) / 4;
        const centerY = (taskRect.top + taskRect.bottom + targetRect.top + targetRect.bottom) / 4;
        this.showFeedback(centerX, centerY, true);

        if (this.score === this.config.items.length) {
            this.finishGame();
        }
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è "–ª–æ–ø–∞–Ω–∏—è" –ø—É–∑—ã—Ä—è
    popBubble(el) {
        el.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
        el.style.transform = 'scale(0)';
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 300); // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    }

    // –§–∏–¥–±–µ–∫: –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —á–∞—Å—Ç–∏—Ü—ã
    showFeedback(x, y, isSuccess) {
        const msg = isSuccess ? this.config.feedback.success : this.config.feedback.error;
        const icon = isSuccess ? this.config.feedback.icon : 'üò¢'; // –ì—Ä—É—Å—Ç–Ω—ã–π —Å–º–∞–π–ª–∏–∫ –¥–ª—è –æ—à–∏–±–∫–∏

        // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const feedbackText = document.createElement('div');
        feedbackText.className = 'feedback-message';
        feedbackText.innerText = msg;
        feedbackText.style.left = x + 'px';
        feedbackText.style.top = (y - 50) + 'px'; // –í—ã—à–µ –º–µ—Å—Ç–∞ –∫–ª–∏–∫–∞
        this.container.appendChild(feedbackText);

        setTimeout(() => feedbackText.remove(), 1500); // –°–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—á–µ–∑–∞–µ—Ç

        // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã
        for (let i = 0; i < 10; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.innerText = icon; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∫–æ–Ω–∫—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ –≥—Ä—É—Å—Ç–Ω—ã–π —Å–º–∞–π–ª–∏–∫
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            p.style.setProperty('--x', (Math.random() - 0.5) * 200 + 'px');
            p.style.setProperty('--y', (Math.random() - 0.5) * 200 + 'px');
            
            this.container.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }
    }

    finishGame() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
        const finalMsg = document.createElement('div');
        finalMsg.className = 'final-feedback';
        finalMsg.innerText = this.config.feedback.final;
        this.container.appendChild(finalMsg);
        
        // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é —Å—É–Ω–¥—É–∫–∞, –ø–æ—Ä—Ç–∞–ª–∞ –∏ —Ç.–¥.
        console.log("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Genially
document.addEventListener('DOMContentLoaded', () => {
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ game-container —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const gameContainer = document.createElement('div');
    gameContainer.id = 'game-container';
    gameContainer.
